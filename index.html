<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>C. difficile Event Review Prompt Generator (No PHI)</title>
<style>
:root{
  --primary:#5a007a;--primary-light:#7c2e9b;--dark:#212529;--border:#dee2e6;
  --success:#198754;--danger:#dc3545;--warn:#b02a37;
  --shadow:0 0 12px rgba(0,0,0,.08);--radius:12px;
  --glow:0 0 0 2px rgba(122,0,153,.15),0 0 14px rgba(122,0,153,.25);
}
*{box-sizing:border-box;font-family:'Segoe UI',Roboto,Arial,sans-serif}
html,body{height:100%}
body{margin:0;background:#f5f5f5;line-height:1.5;color:#1d1d1f}

/* Header */
.header{
  padding:12px 18px;
  background:#fff;
  box-shadow:var(--shadow);
  position:sticky; top:0; z-index:5;
  display:flex; flex-direction:column; gap:6px;
}
.header h1{color:var(--primary);margin:0;font-size:1.15rem}
.header .sub{font-size:.95rem;color:#444}
.header .warn{font-size:.95rem;color:var(--warn);font-weight:800}

/* Layout */
.layout{
  display:grid;
  grid-template-columns:minmax(380px,1fr) minmax(440px,1fr);
  gap:14px;
  padding:14px;
  max-width:1500px;
  margin:0 auto
}
.panel{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex; flex-direction:column;
  min-height:calc(100vh - 130px)
}
.panel-header{
  padding:10px 14px;
  border-bottom:1px solid var(--border);
  position:sticky; top:0; background:#fff; z-index:3;
  display:flex; align-items:center; justify-content:space-between; gap:10px
}
.panel-title{font-weight:800;color:#4b4b4b}
.panel-body{padding:12px 14px;overflow:auto}

/* Inputs */
fieldset{border:1px solid var(--border);border-radius:12px;padding:10px;margin:0 0 14px}
legend{padding:0 6px;color:var(--primary);font-weight:800}
textarea{
  width:100%;
  min-height:160px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:12px;
  resize:vertical;
  background:#fff
}
input[type="date"], select, input[type="text"]{
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px 10px;
  background:#fff;
}
select{cursor:pointer}
.help{font-size:.9rem;color:#5b5b5b}
.small{font-size:.85rem;color:#666}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.pills{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.pill{
  border:1px solid var(--border);
  background:#fafbfc;
  border-radius:999px;
  padding:4px 10px;
  font-size:.85rem;
  color:#444;
}
.note-label{margin:10px 0 6px;font-weight:800;color:#333}
.hr{height:1px;background:var(--border);margin:12px 0}

/* Buttons */
button{
  cursor:pointer;border:none;border-radius:12px;
  padding:12px 18px;font-size:1rem;color:#fff;
  display:inline-flex;align-items:center;gap:8px
}
.btn-primary{background:var(--primary)} .btn-primary:hover{background:var(--primary-light)}
.btn-dark{background:var(--dark)} .btn-dark:hover{background:#343a40}
.btn-ghost{background:#f1f3f5;color:#111}
.btn-ghost:hover{background:#e9ecef}
.btn-wide{min-width:220px}
.btn-glow{box-shadow:var(--glow);transition:box-shadow .2s, transform .02s}
.btn-glow:hover{box-shadow:0 0 0 3px rgba(122,0,153,.18),0 0 18px rgba(122,0,153,.32)}
.btn-glow:active{transform:translateY(1px)}
button:disabled{opacity:.6;cursor:not-allowed}

/* Output */
.output-body{
  white-space:pre-wrap;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:.92rem; line-height:1.4;
}

/* PHI alert */
.phi{
  border:1px solid rgba(220,53,69,.35);
  background:rgba(220,53,69,.06);
  padding:10px 12px;
  border-radius:12px;
  margin-top:10px;
}
.phi strong{color:var(--danger)}
.phi ul{margin:6px 0 0 18px}

/* Misc notes cards */
.card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:#fff;
  margin-top:10px;
}
.card-head{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
}
.card-head .left{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}
.card small{color:#666}

/* Toast */
.toast{
  position:fixed; bottom:18px; right:18px;
  background:var(--success); color:#fff;
  padding:10px 14px; border-radius:12px;
  opacity:0; transform:translateY(50px);
  transition:.25s; z-index:20
}
.toast.show{opacity:1;transform:translateY(0)}

@media(max-width:980px){
  .layout{grid-template-columns:1fr}
  .panel{min-height:auto}
}
</style>
</head>

<body>
  <div class="header">
    <h1>C. difficile Event Review — Prompt Generator (No PHI)</h1>
    <div class="sub">
      Sections: <b>Most recent note</b>, <b>Day-of-dx/index note</b>, <b>prior notes (up to 3 days)</b>, and <b>misc consult/ICU notes</b> (dated).
    </div>
    <div class="warn">
      Use <b>corporate M365 Copilot — Office version</b> only (look for the <b>lower-left profile/icon</b> to sign in). No names. No MRN. No PHI.
    </div>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Paste Notes</div>
        <div class="help" style="margin-left:auto">De-identified review only</div>
      </div>

      <div class="panel-body">

        <!-- Most recent note -->
        <fieldset>
          <legend>Most recent note (after index, if available)</legend>
          <div class="row">
            <label class="help"><b>Date:</b></label>
            <input type="date" id="dateRecent" />
            <span class="small">(optional but recommended)</span>
          </div>
          <textarea id="noteRecent" placeholder="Paste MOST RECENT progress note text (de-identified)."></textarea>
        </fieldset>

        <!-- Index / day of dx note -->
        <fieldset>
          <legend>Day of dx / Index note (Day 0)</legend>
          <div class="row">
            <label class="help"><b>Date:</b></label>
            <input type="date" id="dateIndex" />
            <span class="small">(recommended)</span>
          </div>
          <textarea id="noteIndex" placeholder="Paste INDEX (Day 0) note text (de-identified)."></textarea>

          <div class="pills">
            <div class="pill" id="wc">Words: 0</div>
            <div class="pill" id="tc">Est. tokens: 0</div>
          </div>

          <div id="phiBox" class="phi" style="display:none">
            <strong>Possible identifiers detected.</strong>
            <div class="small">Please remove before generating/copying. Detected patterns:</div>
            <ul id="phiList"></ul>
            <label class="small" style="display:block;margin-top:8px">
              <input type="checkbox" id="confirmDeid" />
              I confirm the pasted text is de-identified (no PHI).
            </label>
          </div>
        </fieldset>

        <!-- Prior notes -->
        <fieldset>
          <legend>Notes before index (optional; up to 3 days back)</legend>

          <div class="row">
            <div class="help"><b>Show prior-day paste boxes:</b></div>
            <select id="priorSelect">
              <option value="0">None</option>
              <option value="1">Show Day −1 only</option>
              <option value="2">Show Day −1 and Day −2</option>
              <option value="3" selected>Show Day −1 to Day −3</option>
            </select>
          </div>

          <div class="small">
            Tip: if notes are long, paste only diarrhea, laxatives/tube feeds, antibiotics, vitals/labs, abd exam, isolation/TBP, and treatment decisions.
          </div>

          <div id="priorWrap" style="margin-top:12px;display:none">
            <div id="priorBoxes"></div>
          </div>
        </fieldset>

        <!-- Misc notes -->
        <fieldset>
          <legend>Misc notes (consults / ICU / other) with dates</legend>

          <div class="row">
            <button class="btn-ghost" type="button" id="addMisc">+ Add misc note</button>
            <span class="small">Use for consult notes, ICU notes, stewardship notes, ID, etc.</span>
          </div>

          <div id="miscWrap"></div>
        </fieldset>

      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Generated Prompt</div>
        <div style="display:flex;gap:10px;align-items:center">
          <button id="generate" class="btn-primary btn-wide btn-glow">Generate Prompt</button>
          <button id="copyOpen" class="btn-dark btn-wide btn-glow" disabled>Copy & Open Copilot</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="output-body" id="promptOut">No prompt generated yet.</div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">Prompt copied ✔</div>

<script>
/******** DOM ********/
const $ = (id)=>document.getElementById(id);

const dateRecent = $("dateRecent");
const noteRecent = $("noteRecent");

const dateIndex = $("dateIndex");
const noteIndex = $("noteIndex");

const priorSelect = $("priorSelect");
const priorWrap = $("priorWrap");
const priorBoxes = $("priorBoxes");

const addMiscBtn = $("addMisc");
const miscWrap = $("miscWrap");

const genBtn = $("generate");
const copyBtn = $("copyOpen");

let currentPrompt = "";

/******** Helpers ********/
function wordCount(t){ return (t.match(/\b\w+\b/g) || []).length; }
function tokenEstimate(words){ return Math.round(words * 1.33); } // crude
function isoOrUnknown(d){ return d ? d : "Unclear (date not provided)"; }
function shortDateLabel(d){ return d ? d : "Undated"; }

/******** PHI detector (simple) ********/
function detectPossiblePHI(t){
  const hits = [];
  const tests = [
    ["Email", /[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i],
    ["Phone", /(\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/],
    ["SSN", /\b\d{3}-\d{2}-\d{4}\b/],
    ["Long ID/MRN-like", /\b\d{7,}\b/],
    ["DOB/Date", /\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/i],
  ];
  for(const [label,re] of tests){ if(re.test(t)) hits.push(label); }
  return [...new Set(hits)];
}

function setCopyEnabled(enabled){ copyBtn.disabled = !enabled; }

/******** Collect text that would be included ********/
function getPriorRows(){
  // Each row: {dateEl, textEl, dayMinus}
  return Array.from(priorBoxes.querySelectorAll("[data-prior-row]")).map(row=>({
    dayMinus: parseInt(row.getAttribute("data-dayminus"),10),
    dateEl: row.querySelector("input[type=date]"),
    textEl: row.querySelector("textarea")
  }));
}

function getMiscCards(){
  return Array.from(miscWrap.querySelectorAll("[data-misc-card]")).map(card=>({
    typeEl: card.querySelector("select"),
    serviceEl: card.querySelector("input[data-service]"),
    dateEl: card.querySelector("input[type=date]"),
    textEl: card.querySelector("textarea")
  }));
}

function includedText(){
  // Include all visible prior boxes (based on selection), plus misc note textareas that have content, plus index/recent.
  let t = "";
  if(noteRecent.value.trim()) t += noteRecent.value + "\n\n";
  t += noteIndex.value + "\n\n";

  const priorRows = getPriorRows();
  for(const r of priorRows){
    if(r.textEl.value.trim()) t += r.textEl.value + "\n\n";
  }

  const misc = getMiscCards();
  for(const m of misc){
    if(m.textEl.value.trim()) t += m.textEl.value + "\n\n";
  }
  return t;
}

function updateCountsAndPHI(){
  const t = includedText();
  const wc = wordCount(t);
  $("wc").textContent = `Words: ${wc}`;
  $("tc").textContent = `Est. tokens: ${tokenEstimate(wc)}`;
  detectPHI();
}

/******** PHI UI ********/
function detectPHI(){
  const t = includedText();
  const hits = detectPossiblePHI(t);
  const phiBox = $("phiBox");
  const phiList = $("phiList");
  const confirm = $("confirmDeid");

  if(hits.length){
    phiBox.style.display = "";
    phiList.innerHTML = hits.map(h=>`<li>${h}</li>`).join("");
    if(!confirm.checked) setCopyEnabled(false);
  }else{
    phiBox.style.display = "none";
    phiList.innerHTML = "";
    confirm.checked = false;
  }
  return hits;
}

$("confirmDeid").addEventListener("change", ()=>{
  const hits = detectPHI();
  if(hits.length && !$("confirmDeid").checked){
    setCopyEnabled(false);
  }else{
    if(currentPrompt) setCopyEnabled(true);
  }
});

/******** Prior boxes rendering (with dates) ********/
function renderPriorBoxes(){
  const n = parseInt(priorSelect.value,10);
  priorBoxes.innerHTML = "";
  if(n <= 0){
    priorWrap.style.display = "none";
    return;
  }
  priorWrap.style.display = "";

  for(let i=1;i<=n;i++){
    const row = document.createElement("div");
    row.setAttribute("data-prior-row","1");
    row.setAttribute("data-dayminus", String(i));

    const label = document.createElement("div");
    label.className = "note-label";
    label.textContent = `Day −${i} note (relative to index)`;

    const meta = document.createElement("div");
    meta.className = "row";
    meta.innerHTML = `
      <span class="help"><b>Date:</b></span>
      <input type="date" />
      <span class="small">(optional)</span>
    `;

    const ta = document.createElement("textarea");
    ta.placeholder = `Paste Day −${i} progress note text (de-identified).`;
    ta.style.minHeight = "120px";

    // events
    meta.querySelector("input[type=date]").addEventListener("change", updateCountsAndPHI);
    ta.addEventListener("input", updateCountsAndPHI);

    row.appendChild(label);
    row.appendChild(meta);
    row.appendChild(ta);
    priorBoxes.appendChild(row);
  }
}

priorSelect.addEventListener("change", ()=>{
  renderPriorBoxes();
  updateCountsAndPHI();
});

/******** Misc notes (dated cards) ********/
let miscCounter = 0;

function makeMiscCard(){
  miscCounter += 1;
  const card = document.createElement("div");
  card.className = "card";
  card.setAttribute("data-misc-card","1");

  card.innerHTML = `
    <div class="card-head">
      <div class="left">
        <select data-type>
          <option value="Consult" selected>Consult</option>
          <option value="ICU">ICU</option>
          <option value="Stewardship">Stewardship</option>
          <option value="ID">ID</option>
          <option value="Other">Other</option>
        </select>
        <input type="text" data-service placeholder="Service (optional, e.g., GI, ID, ICU)" style="min-width:220px" />
        <span class="help"><b>Date:</b></span>
        <input type="date" />
      </div>
      <button type="button" class="btn-ghost" data-remove>Remove</button>
    </div>
    <div class="small" style="margin-top:6px">Paste the consult/ICU note text (de-identified). Keep it short if possible.</div>
    <textarea style="min-height:120px;margin-top:8px" placeholder="Paste misc note text (de-identified)."></textarea>
  `;

  const removeBtn = card.querySelector("[data-remove]");
  removeBtn.addEventListener("click", ()=>{
    card.remove();
    updateCountsAndPHI();
  });

  card.querySelector("select").addEventListener("change", updateCountsAndPHI);
  card.querySelector("input[type=date]").addEventListener("change", updateCountsAndPHI);
  card.querySelector("input[data-service]").addEventListener("input", updateCountsAndPHI);
  card.querySelector("textarea").addEventListener("input", updateCountsAndPHI);

  return card;
}

addMiscBtn.addEventListener("click", ()=>{
  miscWrap.appendChild(makeMiscCard());
  updateCountsAndPHI();
});

/******** Build NOTES block for prompt (token mindful: omit empty textareas) ********/
function notesBlock(){
  const parts = [];

  // Most recent
  const recentTxt = noteRecent.value.trim();
  if(recentTxt){
    parts.push(
`## Most recent note
Date: ${shortDateLabel(dateRecent.value)}
Text:
${recentTxt}`
    );
  }

  // Index (required)
  parts.push(
`## Day of dx / Index note (Day 0)
Date: ${shortDateLabel(dateIndex.value)}
Text:
${noteIndex.value.trim() || "[No text provided]" }`
  );

  // Prior
  const priorRows = getPriorRows();
  for(const r of priorRows){
    const txt = r.textEl.value.trim();
    if(!txt) continue;
    parts.push(
`## Prior note (Day −${r.dayMinus} relative to index)
Date: ${shortDateLabel(r.dateEl.value)}
Text:
${txt}`
    );
  }

  // Misc
  const misc = getMiscCards();
  for(const m of misc){
    const txt = m.textEl.value.trim();
    if(!txt) continue;
    const type = (m.typeEl.value || "Misc").trim();
    const svc = (m.serviceEl.value || "").trim();
    const svcText = svc ? `; Service: ${svc}` : "";
    parts.push(
`## Misc note (${type}${svcText})
Date: ${shortDateLabel(m.dateEl.value)}
Text:
${txt}`
    );
  }

  return parts.join("\n\n");
}

/******** Prompt generation ********/
genBtn.addEventListener("click", ()=>{
  const idx = noteIndex.value.trim();
  if(!idx){
    alert("Please paste the Day-of-dx / Index note (Day 0).");
    return;
  }

  const hits = detectPHI();
  if(hits.length && !$("confirmDeid").checked){
    alert("Possible identifiers detected. Remove PHI or confirm de-identification before generating/copying.");
    return;
  }

  const p =
`You are an infection prevention / quality review assistant for a **C. difficile event review**.
This is a **de-identified** internal review.



OUTPUT CONSTRAINTS (token-mindful):
- Be concise. Prefer bullets.
- Do NOT quote long note passages.
- For "Evidence", include a very short snippet (<= 12 words) OR a tight paraphrase + which note/date it came from.
- If something is not clearly documented, say **Unclear — not documented**.
- Keep total output roughly ~450–850 tokens when possible.

IMPORTANT:
- This is NOT clinical decision support. Do not provide direct patient-care orders.
- Be conservative; separate supported vs uncertain.
- Provide a degree of certitude and the missing facts that would increase certainty.

Context reminder:
- Use corporate M365 Copilot — Office version only (lower-left profile/icon to sign in). 

=== NOTES (de-identified) ===
${notesBlock()}

---
REQUIRED OUTPUT (use these exact section headers)

0) Structured Answer Set (Yes/No/Unclear + Evidence)
Answer EACH item below. For each line use:
- Answer: Yes / No / Unclear
- Evidence: "<note label> (<date>): <short snippet/paraphrase>" OR "Unclear — not documented"

A) ≥3 unexplained/unformed stools within 24h at time of test order?
B) Prior history of C. difficile?
C) Systemic antibiotics in last 60 days before positive test?
D) Signs/symptoms at time test ordered (select all that apply; if not documented, mark Unclear):
   - Fever >38°C
   - Abdominal tenderness/cramping/distention
   - WBC >10k within 24h of unformed stools
   - Recent chemotherapy/immunosuppression
   - None of the above (ONLY if the record explicitly supports none)
E) Confounders within last 48h (select all that apply; if not documented, mark Unclear):
   - Laxatives
   - Enemas
   - Tube feeds
   - Bowel prep
   - None of the above (ONLY if explicitly supported)
F) Date admitted (M/d/yyyy if present; otherwise Unclear)
G) Met clinical criteria on day 1-2-3 upon admission? (POA window concept)
H) Hospital location where C. diff test ordered:
   - ED / ICU / Non-ICU / Other / Unclear
I) Date initial C. diff testing ordered (M/d/yyyy if present; otherwise Unclear)
J) Test result type (choose ONE if documented; otherwise Unclear):
   - GDH+/Toxin EIA+
   - GDH+/Toxin EIA-/Toxin gene PCR+
K) Treated after result posted? (Yes/No/Unclear) — if Yes, state what therapy is documented.
L) In timeframe, adherence deficient to hand hygiene and/or transmission-based precautions?
M) Potential opportunities identified (select all that apply; each must have Evidence or Unclear):
   - Clinical criteria for testing not met
   - Earlier diagnosis (POA window)
   - Earlier specimen collection (POA window)
   - Diagnosis of likely colonization
   - Antimicrobial prescribing appropriateness
   - Transmission prevention (HH, SP, TBP, EVS)
   - None of the above (ONLY if record supports no opportunities)

1) Unanswered Questions to Share with the Care Team
- First choose emphasis role based on what gaps are most actionable from the notes:
  "Emphasis: MD" OR "Emphasis: Nurse" OR "Emphasis: PCT" (1 sentence why)
- Then list 10–14 questions total:
  - 6–8 for the emphasized role
  - 2–3 each for the other roles
- Questions must be bedside/actionable (who/what/when).

2) Timeline (place near the END)
- Chronological summary using the dates provided for each note.
- If some notes are undated, place them approximately and label "Undated".
- For each timepoint, include: stool frequency/consistency; confounders; antibiotics; vitals/labs; abd findings; isolation/TBP; test/treatment milestones.
- If missing, label "Not documented".

3) Executive Summary (place LAST)
- 3–6 bullets summarizing what happened + key uncertainty + top opportunity.

Remember: conservative tone,token-mindful.`;

  $("promptOut").textContent = p;
  currentPrompt = p;
  setCopyEnabled(!(hits.length && !$("confirmDeid").checked));
});

/******** Copy & open ********/
copyBtn.addEventListener("click", ()=>{
  if(!currentPrompt){ alert("No prompt generated."); return; }
  const hits = detectPHI();
  if(hits.length && !$("confirmDeid").checked){
    alert("Possible identifiers detected. Remove PHI or confirm de-identification before copying.");
    return;
  }
  navigator.clipboard.writeText(currentPrompt).then(()=>{
    const t = $("toast"); t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
    window.open("https://copilot.microsoft.com", "_blank");
  }).catch(()=>alert("Copy failed."));
});

/******** Event wiring ********/
noteRecent.addEventListener("input", updateCountsAndPHI);
noteIndex.addEventListener("input", updateCountsAndPHI);
dateRecent.addEventListener("change", updateCountsAndPHI);
dateIndex.addEventListener("change", updateCountsAndPHI);

/******** Init ********/
renderPriorBoxes();              // default selection shows Day -1..-3
updateCountsAndPHI();
</script>
</body>
</html>
